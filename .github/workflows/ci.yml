# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 hyperpolymath
name: Idris 2 CI

permissions: read-all

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  IDRIS_VERSION: '0.8.0'

jobs:
  # Language compliance check - runs first and fast
  language-check:
    name: Language Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Verify Idris-only in src/
        run: |
          echo "ğŸ‰ ddraig-ssg Language Compliance Check"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Checking for forbidden languages in src/..."
          forbidden=$(find src/ -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.hs" -o -name "*.rb" -o -name "*.go" -o -name "*.java" \) 2>/dev/null || true)
          if [ -n "$forbidden" ]; then
            echo "âŒ ERROR: Found forbidden language files in src/:"
            echo "$forbidden"
            echo ""
            echo "ddraig-ssg is THE Idris SSG. No other languages permitted in src/."
            exit 1
          fi
          echo "âœ… OK: Only Idris files in src/"

      - name: Verify ReScript-only in adapters/
        run: |
          echo "Checking adapters/ directory..."
          if [ -d "adapters/src" ]; then
            forbidden=$(find adapters/src/ -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.idr" \) 2>/dev/null || true)
            if [ -n "$forbidden" ]; then
              echo "âš ï¸ WARNING: Non-ReScript files in adapters/src/:"
              echo "$forbidden"
            fi
          fi
          echo "âœ… OK: Adapter language check complete"

  # Main build job
  build:
    name: Build & Type Check
    runs-on: ubuntu-latest
    needs: language-check

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Set up Idris 2
        uses: idris-community/setup-idris@a32a5481bce5bcb57fec37a6fbd1d2d4dbbe0da9 # v1
        with:
          version: '0.8.0'

      - name: Cache Idris build
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4
        with:
          path: |
            src/build/ttc
            ~/.idris2
          key: idris-${{ runner.os }}-${{ env.IDRIS_VERSION }}-${{ hashFiles('src/**/*.idr') }}
          restore-keys: |
            idris-${{ runner.os }}-${{ env.IDRIS_VERSION }}-

      - name: Type Check
        run: |
          echo "ğŸ” Type checking Ddraig.idr..."
          cd src && idris2 --typecheck Ddraig.idr
          echo "âœ… Type check passed"

      - name: Build
        run: |
          echo "ğŸ”¨ Building ddraig-ssg..."
          if [ -f "ddraig.ipkg" ]; then
            idris2 --build ddraig.ipkg
          else
            cd src && idris2 Ddraig.idr -o ddraig
          fi
          echo "âœ… Build complete"

  # Test job
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Set up Idris 2
        uses: idris-community/setup-idris@a32a5481bce5bcb57fec37a6fbd1d2d4dbbe0da9 # v1
        with:
          version: ${{ env.IDRIS_VERSION }}

      - name: Cache Idris build
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4
        with:
          path: |
            src/build/ttc
            ~/.idris2
          key: idris-${{ runner.os }}-${{ env.IDRIS_VERSION }}-${{ hashFiles('src/**/*.idr') }}
          restore-keys: |
            idris-${{ runner.os }}-${{ env.IDRIS_VERSION }}-

      - name: Build for Testing
        run: |
          cd src && idris2 Ddraig.idr -o ddraig

      - name: Run Markdown Tests
        run: |
          echo "ğŸ§ª Testing Markdown parser..."
          ./src/build/exec/ddraig test-markdown

      - name: Run Frontmatter Tests
        run: |
          echo "ğŸ§ª Testing Frontmatter parser..."
          ./src/build/exec/ddraig test-frontmatter

      - name: Run Full Pipeline Tests
        run: |
          echo "ğŸ§ª Testing full pipeline..."
          ./src/build/exec/ddraig test-full

  # Adapter build job
  adapter:
    name: Build Adapter
    runs-on: ubuntu-latest
    needs: language-check

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Set up Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: adapters/package-lock.json

      - name: Install dependencies
        working-directory: adapters
        run: npm ci || npm install

      - name: Build ReScript adapter
        working-directory: adapters
        run: npm run build

      - name: Verify build output
        working-directory: adapters
        run: |
          if [ -f "src/DdraigAdapter.mjs" ]; then
            echo "âœ… Adapter build successful"
          else
            echo "âš ï¸ Adapter build output not found (may need ReScript setup)"
          fi

  # Security checks
  security:
    name: Security Checks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Check SHA-pinned actions
        run: |
          echo "ğŸ”’ Checking GitHub Actions are SHA-pinned..."
          unpinned=$(grep -r "uses:" .github/workflows/*.yml | grep -v "@[a-f0-9]\{40\}" | grep -v "^#" || true)
          if [ -n "$unpinned" ]; then
            echo "âš ï¸ Found actions without SHA pins:"
            echo "$unpinned"
          else
            echo "âœ… All actions are SHA-pinned"
          fi

      - name: Check for secrets in code
        run: |
          echo "ğŸ”’ Checking for potential secrets..."
          secrets=$(grep -rn "BEGIN.*PRIVATE\|password\s*=.*['\"]" --include="*.idr" --include="*.res" src/ adapters/src/ 2>/dev/null || true)
          if [ -n "$secrets" ]; then
            echo "âš ï¸ Potential secrets found - review manually:"
            echo "$secrets"
          else
            echo "âœ… No obvious secrets detected"
          fi

      - name: Audit npm dependencies
        working-directory: adapters
        run: |
          echo "ğŸ”’ Running npm audit..."
          npm audit --audit-level=high || echo "âš ï¸ npm audit found issues (or npm install needed)"
